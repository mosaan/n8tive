# 開発企画書

この文書は `n8tive`（n8n Desktop Wrapper）プロジェクトの開発構想・実現性・計画を、従来の統一プロセスに倣った章立てでまとめたものです。個人開発のスコープに合わせて、構想と技術的な確からしさ、初期の計画に重点を置いています。

#### 第1章 開発構想とビジネスの正当性 (Vision and Justification)

##### 1.1 システムの概要と目標
- **目標**: Node.js を事前インストールせず、ダウンロードしてすぐ n8n を利用できる「デスクトップアプリ化」された n8n を提供する。
- **主要な価値**: 最新の n8n を Electron ラッパー経由で起動し、ローカルで安全にワークフローを開発/実行できる UX を提供する（ダウンロード→起動だけで完結）。
- **期待される成果**: カジュアルなユーザーや学習者が CLI やブラウザ設定を意識せず、n8n のエディタにアクセスできること。
- **成功基準**: 1) Windows向けでパッケージングできる、2) n8n サーバーが自動的に起動し UI 表示につながる、3) データが `app.getPath('userData')/.n8n/` ディレクトリに永続化される。

##### 1.2 システムの責任範囲の定義
- 含む: Electron + n8n CLI のバンドル、Electron メイン/レンダラーによる UI 表示、プロセス管理、ロギングとエラーハンドリング。
- 含まない: 外部からの Webhook 受信やクラウド展開。ランタイム自体に n8n を修正は加えず、CLI をそのまま利用。
- 外部インターフェイス: ユーザー操作（UI クリック）、OS ファイルシステム（ユーザーデータ保存）、ローカル HTTP (`127.0.0.1:<port>`) のみ。

#### 第2章 技術的実現性の確立とアーキテクチャ候補 (Technical Feasibility and Architecture Candidate)

##### 2.1 アーキテクチャ候補の概要
- 新規部分: Electron メインから `child_process.fork()` で n8n CLI を起動し、ログとステータスを `contextBridge` で Renderer に渡すオーケストレーション層。
- 技術スタック: `electron-vite` で開発/ビルド、`electron-builder` で各 OS パッケージ、`typescript` をコア言語、`n8n` を dependencies として同梱。
- 制約: n8n は大容量（500MB）で、`asar` 圧縮＋`asarUnpack` で負荷を軽減。起動前にロード画面を表示し、最大 100 個までのポート探索により競合を吸収。
- 確信の根拠: 各処理をモジュール（`n8n-manager`, `port-finder`, `preload`）で分離し、ロギング・再起動・エラー処理を確立しているため、安定したアーキテクチャを導出可能。

##### 2.2 致命的リスクの洗い出しと軽減計画
1. **パッケージサイズ**: n8n そのものが数百MB。`asar` 有効化と `node_modules/n8n` の `asarUnpack` 設定を使い、必要なファイルだけ展開。
2. **起動時間**: 初回起動は 30秒〜1分。ローディング画面とログ表示で体感時間を改善し、ユーザーへ進捗/エラーを可視化。
3. **Windows 固有の問題**: `child_process.fork()` でパス区切りやシグナル処理が異なる可能性。開発段階で Windows 実機または VM での検証を行う。
4. **外部アクセス**: ローカル専用のため Webhook/受信ができない。必要であればユーザーへドキュメントで説明する（本仕様ではカバーしない）。

##### 2.3 ユースケースの優先度づけ（アーキテクチャ駆動）
- 最優先:「アプリ起動→n8n サーバー起動→UI 表示」のフロー。ログストリーミングと準備完了検出も同時に対応。
- 次点: 再起動/終了時のプロセス整合性（`restart-n8n`、ウィンドウクローズ時に `SIGTERM` 送付）。
- 継続的改善: ビルド/パッケージングスクリプト（electron-builder）を充実させることで、コードの完成後に各プラットフォームを確実に配布。

#### 第3章 開発計画の初期見積もりと評価（Planning and Assessment）

##### 3.1 プロジェクトの初期段階の計画
- **Phase 1: 基本構造** ✅ 完了 – `package.json` と TypeScript 設定、Electron ウィンドウの表示まで。目標: `electron-vite dev` でロード画面が出る。
- **Phase 2: n8n 起動** ✅ 完了 – `N8nManager` 実装、`fork()`、ログストリーム、停止再起動、ポート探索、ローディング画面へのイベント通知。
- **Phase 3: UI 統合** ✅ 完了 – `loading.html` でログ/ステータス表示、`onN8nReady` で `loadURL`、`onN8nError` でエラー領域を表示。既存実装で要件を満たしている。
- **Phase 4: ビルド・パッケージング** ✅ 完了 – `electron-builder.yml` を整備し、Windows（nsis）でテスト完了。node_modules 除外問題をジャンクション方式で解決。
- **テスト項目**:
  - ✅ n8n サーバーの起動確認（`onReady` コールバック）
  - ✅ ポート競合時の自動切り替え（`port-finder`）
  - ✅ アプリ終了時の n8n プロセス確実な終了（`stop()`）- 起動中の終了も含む
  - ✅ ワークフロー作成・実行（UI 経由）
  - ✅ データ永続性（再起動後にも `.n8n` 内容保持）
  - ✅ 各 OS でのパッケージング動作確認（Windows完了、ジャンクション方式で解決）
- **Phase 5: 快適性向上** ✅ 完了 – バックグラウンド起動（Windowsのシステムトレイにアイコン表示）による常駐、ポート競合時のセルフリカバリと Electron メニューからポート番号を指定して再起動できる設定メニュー（設定したポート番号は `app.getPath('userData')/n8tive_config.json` に保存し次回起動に反映。ポート未指定の場合のみデフォルトから +1 探索で自動解決。メニュー/ダイアログから「自動設定に戻す」を選ぶと保存済みポートを消去し自動探索に復帰）。n8n 2.0.2へのバージョンアップ、ログファイル出力機能も実装済み。
- **Phase 6: 国際化とログビューア** ✅ 完了 – 全UIを日本語から英語に国際化（システムトレイメニュー、ダイアログ、HTML lang属性）。ログフォルダビューア機能の追加（システムトレイおよびアプリケーションメニューバーからログディレクトリをエクスプローラーで開く機能）。File/View/Helpメニューを持つアプリケーションメニューバーの実装。
- **Phase 7: 安全性向上** ⏳ 未着手 – デフォルトをローカルアクセスのみとし、設定で外部アクセスを明示的に許可できるようにする（アクセス元制限やバインドアドレス変更を切替可能に）

##### 3.2 投資対効果（費用対効果）の評価（経済性）
- **投資**: Electron/Vite/Electron-builder などのセットアップ、n8n の依存インストール（容量と時間）、各プラットフォームでの検証。
- **期待される便益**: n8n の導入障壁を下げ、デスクトップ感覚で利用できるようにすることで、個人開発や学習用途での採用が進む。
- **判断基準**: 少量の個人時間で実装でき、ポートフォリオとしても価値ある製品化が見込めるため、継続するに値すると判断。

---

### 補足：この開発企画書の位置づけ
方向づけフェーズの終了時に本書をもとに技術的正当性と経済性を検討し、その後の推敲フェーズ（実装＋テスト）の指針とする。個人開発においては自分の時間投資の判断材料として活用する。
