# n8tive 開発レポート - 2025/12/12 #1

## 作業概要
n8tiveプロジェクトの初期実装を実施。実現可能性を確認するための最小限の実装を完了。

## 実施内容

### 1. プロジェクト初期化と基本設定
- **パッケージ管理の方針決定**
  - pnpmを使用することを決定
  - package.jsonの編集方針を確立：依存関係はコマンド経由、設定項目のみ直接編集
  - CLAUDE.mdに方針を記録

- **プロジェクト設定ファイルの作成**
  - `package.json`: pnpm initで初期化後、スクリプトとメタデータを設定
  - `tsconfig.json`: TypeScript設定（ES2021、CommonJS、strict mode）
  - `electron.vite.config.ts`: Electron Vite設定（main/preload/renderer）
  - `electron-builder.yml`: パッケージングビルド設定（asar + asarUnpack）
  - `.gitignore`: node_modules、dist、out、releaseなどを除外
  - `.npmrc`: ビルドスクリプト制御の設定
  - `.pnpm-approvals.json`: pnpmのビルドスクリプト承認設定

- **依存関係のインストール**
  - 開発依存: electron, electron-vite, electron-builder, typescript, @types/node
  - 本番依存: n8n, sqlite3, better-sqlite3

### 2. Electronアプリケーションの実装
ドキュメント（docs/00_*.md）の設計に基づき、以下のコンポーネントを実装：

- **src/main/port-finder.ts**
  - 利用可能なポートを検索する機能
  - デフォルト5678から最大100ポートまで試行
  - net.createServer()を使用した空きポート検出

- **src/main/preload.ts**
  - contextBridgeによる安全なIPC通信の実装
  - Renderer向けAPI公開: onN8nLog, onN8nReady, onN8nError, restartN8n
  - TypeScript型定義を含む

- **src/main/n8n-manager.ts**
  - n8n CLIプロセスの管理クラス
  - child_process.fork()によるn8nの起動
  - 標準出力/エラー出力の監視とログ転送
  - ポート管理と環境変数設定（N8N_PORT, N8N_HOST, N8N_USER_FOLDER等）
  - start/stop/restart機能の実装

- **src/main/index.ts**
  - Electronメインプロセスのエントリーポイント
  - BrowserWindowの作成とライフサイクル管理
  - N8nManagerの初期化と起動
  - IPCハンドラーの実装（restart-n8n）
  - アプリケーション終了時のクリーンアップ処理

- **src/renderer/loading.html**
  - n8n起動中のローディングUI
  - ログ表示機能（リアルタイム更新、自動スクロール）
  - エラー表示と再起動ボタン
  - グラデーション背景とスピナーアニメーション

### 3. ビルドと動作確認
- `pnpm run build`でビルド成功を確認
- 出力ディレクトリが`out`になることを確認し、設定を調整
- Electronバイナリのインストール（手動でinstall.js実行）
- 開発モードでアプリケーション起動を確認

### 4. 発見した課題
- **sqlite3のネイティブモジュール問題**
  - n8nがsqlite3を必要とするが、ビルドスクリプトが実行されない
  - pnpmのビルドスクリプト承認システムによる制限
  - エラーメッセージ: "SQLite package has not been found installed"
  - 複数の解決策を試行中（.npmrc、.pnpm-approvals.json等）

## 技術的な意思決定

### パッケージ管理方針
- **決定**: pnpmを使用し、依存関係の追加・削除は必ずコマンド経由で行う
- **理由**: バージョン管理の一貫性を保ち、ロックファイルとの整合性を確保するため
- **記録**: CLAUDE.mdに方針を明記

### n8n CLIパスの解決方法
- **初回実装**: `require.resolve('n8n')`を使用
- **修正後**: `require.resolve('n8n/package.json')`からbin/n8nを相対パスで指定
- **理由**: より確実にn8nのCLIスクリプトパスを取得するため

### ビルド出力ディレクトリ
- **決定**: electron-viteのデフォルト`out`ディレクトリを使用
- **調整**: package.jsonのmainとelectron-builder.ymlのfilesを`out`に変更

## 次のステップ
1. sqlite3のビルドスクリプト実行問題を解決
2. n8nが正常に起動することを確認
3. Electronアプリ経由でn8n UIにアクセスできることを確認
4. 基本的な動作テスト（ワークフロー作成、実行、データ永続性）

## 参考情報
- n8n公式: https://n8n.io/
- Electron: https://www.electronjs.org/
- electron-vite: https://electron-vite.org/
- pnpm: https://pnpm.io/

## 作業時間
約2時間（設計確認、実装、ビルド確認、依存関係の調査を含む）
