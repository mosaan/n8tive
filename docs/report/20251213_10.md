# n8tive 開発レポート - 2025/12/13 #10

## 作業概要
ビルド高速化のため、アプリ本体の依存から n8n / sqlite 系を切り離し、tar ベースの配布専用バージョン定義に分離した。electron-builder の依存スキャン対象を最小化し、不要なネイティブ再ビルド指定を整理。

## 実施内容

### 1. トップレベル依存の整理
- `package.json` から `n8n` / `better-sqlite3` / `sqlite3` を削除し、tar 展開用だけで持つ形に変更。
- `rebuild:native` スクリプトを削除（sqlite 用の再ビルドが不要になったため）。
- `pnpm-workspace.yaml` の `onlyBuiltDependencies` から sqlite 系を削除。

### 2. n8n バージョンの供給源を分離
- 新規 `n8n-version.json` を追加し、n8n のバージョンをこのファイル（または環境変数 `N8N_VERSION`）から取得するように変更。
- `scripts/prepare-n8n.js` を更新し、`package.json` への依存を解消。バージョン読み込みの存在チェックとエラーメッセージを追加。
- `pnpm install --lockfile-only` を実行し、ロックファイルから n8n/sqlite 系エントリを除去。

## 影響と意図
- electron-builder の依存収集対象から巨大な n8n 依存ツリーを外し、ビルド時間短縮を狙う。
- tar 展開で同梱される n8n 側に sqlite/better-sqlite3 が含まれるため、アプリ本体からの削除による動作影響はなし。
- バージョンを `n8n-version.json` に集約したことで、依存追加なしに n8n バージョンを上げ下げ可能（環境変数でも上書き可）。
- `tar` を main バンドルに含めるよう `electron.vite.config.ts` を調整（`externalizeDeps: false` + builtins/electronのみ external）。
- `electron-builder.yml` の `files` から `!node_modules/**/*` を除去し、runtime 依存（tar など）が確実に同梱されるように戻した（現状は prod 依存が小さいため許容）。
- 過去の依存スキャン回避のための `ELECTRON_BUILDER_SKIP_DEPENDENCY_SCAN` と `buildDependenciesFromSource`/`npmRebuild` 指定を撤廃し、最小構成に整理。
- tar 方式を廃止し、`n8n-dist` ディレクトリをそのまま `extraResources` に同梱する方針へ移行（tar 展開待ちを解消）。
- メインプロセスは `resources/n8n-dist` を直接参照（必要なら `N8N_DIST_PATH` で上書き）、進捗/ETA はコピー不要になったため 100% 即完了を通知。
- `extraResources` で `n8n-dist/node_modules` を確実に含めるよう `filter` を明示（node_modules が省かれる問題への対処）。
- 【残課題】インストーラ生成後の `resources/n8n-dist` に node_modules が含まれない事象が継続。`filter: node_modules/**` を指定してもコピーされておらず、electron-builder の挙動要確認。

## 残課題・次のステップ
- `resources/n8n-dist` に node_modules が同梱されない原因の究明（electron-builder の extraResources に対する node_modules 無視挙動の可能性）。
- 対策案の検証：
  - `extraResources` で `from: ./n8n-dist/node_modules` を別エントリで指定する
  - もしくは `files` に `n8n-dist/**` を含める形に変更して検証
  - ビルドログで extraResources のコピー対象を確認
  - `.n8n-prepared` の扱いを再確認し、必ず n8n-dist を生成後に package 実行

## メモ / 次の確認ポイント
- 古い `node_modules` を再生成して軽量化を反映する場合は `rm -rf node_modules && pnpm install` を実行する。
- パッケージング時はこれまで通り `npm run package`（内部で `prepare:n8n` 実行）で OK。
