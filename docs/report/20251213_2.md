# n8tive 開発レポート - 2025/12/13 #2

## 作業概要
MCP サーバ `electron_debug` が初期ハンドシェイクで落ちる問題を調査し、再現条件と暫定対応策を確認した。

## 実施内容

### 1. エラー状況の把握
- エージェント起動時に `MCP client for "electron_debug" failed to start: connection closed during initialize` が発生していることを確認。
- 直近のログファイルは見当たらず、サーバープロセス自体が起動直後に終了していると推測。

### 2. 再現試験と挙動確認
- プロジェクトルートで `pnpm dlx electron-mcp-server --version` を実行すると、環境変数を渡さない場合に `SCREENSHOT_ENCRYPTION_KEY environment variable is required but not set` で即時終了することを確認。
- 同コマンドを以下の環境変数を事前に設定して再実行すると正常起動することを確認し、MCP サーバが起動してツール一覧が出力されることを確認。
  - `ELECTRON_PROJECT_PATH=.`  
  - `SCREENSHOT_ENCRYPTION_KEY=e7cf9a8f518b560565add20578f1ab579721cf5890b6c82ee13f0fde5247fd65`

### 3. 設定ファイルと環境の確認
- `.mcp.json` では `electron-debug`（ハイフン）のサーバー定義と上記環境変数が記載されている。
- `C:\Users\moref\.codex\config.toml` でも `electron_debug`（アンダースコア）のサーバーに同じ環境変数が指定されていることを確認。
- 実行シェルの `$env:SCREENSHOT_ENCRYPTION_KEY` は空で、環境変数が自動的には注入されていない状態を確認。したがって MCP 起動プロセスがキーを受け取れず即終了していると判断。

### 4. 原因の推定
- ハンドシェイク失敗の直接原因は、`SCREENSHOT_ENCRYPTION_KEY` が子プロセスに渡らず `electron-mcp-server` が起動直後に終了すること。
- サーバー名が `electron_debug`（config.toml）と `electron-debug`（.mcp.json）で揺れており、どちらが実際に起動対象になっているかにかかわらず、環境変数の注入が行われていないため失敗している可能性が高い。

### 5. 暫定対応案
- エージェント／CLI を起動する前に、シェルで上記2つの環境変数を明示的に設定してから起動する（現状これでサーバーが正常起動することを確認済み）。
- 併せてプロジェクトルート（`D:\Dev\n8tive`）から起動し、`.mcp.json` の設定が読まれる状態を担保する。

## 次のステップ
1. エージェント起動時に環境変数が確実に注入されるよう、Codex の設定読み込み手順を確認し必要なら調整する（config.toml と .mcp.json のサーバー名差異も整理）。
2. 環境変数を設定した状態で再度エージェントを起動し、MCP ハンドシェイクが通るかを再検証する。
3. MCP サーバ経由で Electron 側のログ取得・操作が機能するか簡易動作確認を行う。
