# n8tive 開発レポート - 2025/12/13 #9

## 作業概要
Phase 4（ビルド・パッケージング）の実装を開始。従来のアプローチ（asarUnpack）でelectron-builderの致命的な問題に遭遇し、AutomateJoyプロジェクトを参考にtarアーカイブ方式を採用して実装完了。

## 実施内容

### 1. Phase 4 ビルド試行と問題発見

#### 初回ビルド試行
electron-builder.ymlとpackage.jsonの設定を確認し、Windows NSIS インストーラのビルドを試みた。

**発生した問題：**
1. **pnpm list エラー**
   - electron-builderが `pnpm list --prod --json --depth Infinity` を実行
   - n8nの巨大な依存関係ツリーでJSON出力がJavaScript文字列長上限（約500MB）を超過
   - エラー: "Invalid string length"

2. **スタックオーバーフロー**
   - electron-builderの `NpmNodeModulesCollector` が再帰的に依存関係を収集
   - n8nの深い依存関係ツリーでスタックオーバーフローが発生
   - エラー: "Maximum call stack size exceeded"

#### 試した回避策（すべて失敗）
- `ELECTRON_BUILDER_SKIP_DEPENDENCY_SCAN=1` 環境変数 → 効果なし
- `.npmrc` に `node-linker=hoisted` 追加 → エラー継続
- `asar: false` に変更 → 同じエラー
- `extraResources` でnode_modulesをコピー → メモリ不足

### 2. AutomateJoyプロジェクトの発見と調査

ユーザーから類似プロジェクト [AutomateJoy](https://github.com/newcl/AutomateJoy) の情報を得て調査。

#### AutomateJoyのアプローチ
1. **ビルド前**: 別ディレクトリ（n8n-dist）でn8nをインストール
2. **tarアーカイブ作成**: `n8n-dist` 全体を `n8n-dist.tar` に圧縮
3. **extraResources**: tarファイルを単一ファイルとして配置
4. **実行時展開**: アプリ起動時にtarを展開してn8nを実行（※現行では n8n-dist を直接含める方式に移行）

#### この方式の利点
- ✅ electron-builderのnode_modulesコレクターを完全に回避
- ✅ 単一ファイルなのでビルド時間が大幅短縮
- ✅ 依存関係ツリーの深さや循環参照に影響されない
- ✅ 実行時展開で柔軟性が高い

### 3. tarアーカイブ方式の実装

#### 3.1 ビルドスクリプト作成

**scripts/prepare-n8n.js:**
```javascript
// n8n-distディレクトリにpackage.json作成
// npm install でn8nと依存関係をインストール
// build-n8n-tar.jsを実行してtarアーカイブ作成
// マーカーファイル作成（2回目以降スキップ）
```

**scripts/build-n8n-tar.js:**（現行では削除済み、当時の実装記録）
```javascript
// n8n-distディレクトリをtar.c()でアーカイブ化
// 非圧縮tar（gzip: false）で約1GBのファイル作成
```

#### 3.2 ビルド設定更新

**electron-builder.yml:**
```yaml
files:
  - out/**/*
  - "!node_modules/**/*"  # node_modulesを除外
extraResources:
  - n8n-dist.tar  # tarファイルのみを含める
asar: true  # 再度有効化
```

**package.json:**
```json
{
  "scripts": {
    "prepare:n8n": "node scripts/prepare-n8n.js",
    "package": "npm run prepare:n8n && npm run build && cross-env ELECTRON_BUILDER_SKIP_DEPENDENCY_SCAN=1 electron-builder"
  },
  "dependencies": {
    "tar": "^7.5.2"  # 実行時展開に必要
  }
}
```

#### 3.3 実行時展開ロジック実装

**src/main/n8n-manager.ts:**
```typescript
private async ensureN8nInstalled(): Promise<void> {
  // マーカーファイルとn8n-distディレクトリの存在確認
  // なければresources/n8n-dist.tarを展開
  // 展開後マーカーファイル作成
  this.n8nInstallPath = n8nDistPath;
}

async start(): Promise<void> {
  // 最初にensureN8nInstalled()を呼び出し
  await this.ensureN8nInstalled();

  // 展開したn8n-distからn8n CLIを起動
  const n8nCliPath = join(this.n8nInstallPath, 'node_modules', 'n8n', 'bin', 'n8n');
  // ...
}
```

### 4. ビルドテスト結果

#### n8n-dist.tar 作成成功
```
[prepare-n8n] n8n-dist size: 908.64 MB
[prepare-n8n] tar file size: 1023.42 MB
```

**内訳：**
- n8n本体とnode_modules: 約909MB
- tarアーカイブ（非圧縮）: 約1024MB
- 1734パッケージをインストール

#### 次回の課題
- 実際のelectron-builderビルドテスト（次回作業）
- 開発環境でのtar展開動作確認
- 最終的なNSISインストーラ生成と動作確認

### 5. ドキュメント更新

**docs/05_BuildPackaging.md:**
- 「ビルド戦略の変更：tarアーカイブ方式の採用」セクション追加
- 従来アプローチの問題点を文書化
- AutomateJoyプロジェクトの参照
- tar方式の利点と実装方針を記載
- 参考リンク追加（electron-builder/pnpm issue）

**.gitignore:**
```
# n8n distribution files (generated during build)
n8n-dist/
n8n-dist.tar
.n8n-prepared
.n8n-installed
```

## 技術的な発見

### electron-builder 26.x の既知の問題
以下の問題が確認され、対処法が必要だった：
- [Issue #8857](https://github.com/electron-userland/electron-builder/issues/8857): node-module-collector のスタックオーバーフロー
- [pnpm Issue #7079](https://github.com/pnpm/pnpm/issues/7079): Invalid string length エラー

### tarアーカイブのサイズ管理
- 非圧縮tar: 1024MB（実装済み）
- gzip圧縮すれば更に小さくできる可能性（将来的な最適化）
- ただし、展開時間とのトレードオフを考慮

### pnpm vs npm の選択
- プロジェクト本体: pnpm（hoisted構造）
- n8n-dist: npm（独立環境、ロックファイル干渉を回避）

## 所感

Phase 4の開始早々、electron-builderとn8nの組み合わせで深刻な問題に直面したが、ユーザーから提供されたAutomateJoyプロジェクトの情報により、より堅牢なアプローチ（tarアーカイブ方式）を発見・実装できた。

この方式は以下の点で優れている：
1. **確実性**: electron-builderの内部処理に依存しない
2. **パフォーマンス**: 単一ファイルコピーで高速
3. **保守性**: シンプルで理解しやすい
4. **移植性**: 他のプラットフォームでも同じアプローチが使える

次回は実際のビルドテストを実施し、NSISインストーラが正常に作成されることを確認する。Phase 4完了まであと一歩。
