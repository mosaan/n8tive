# 作業記録 2024-12-14 #1

## 作業概要
electron-builder の `extraResources` で `node_modules` ディレクトリが同梱されない問題を解決。

## 背景・課題
`docs/report/20251213_10.md` の残課題として、以下の問題が発生していた：
- electron-builder の `extraResources` で `n8n-dist` を同梱しようとしたが、その中の `node_modules` が含まれない
- `filter: node_modules/**` を指定しても効果がない

## 調査結果

### インターネット検索による類似事例の発見
以下の検索を実施：
- "electron-builder extraResources node_modules not included"
- "electron-builder extraResources ignore node_modules filter"
- "electron-builder copy node_modules to resources"

### 根本原因の特定
**electron-builder 20.15.2 以降、`node_modules` という名前のディレクトリを意図的にコピーしない仕様**があることが判明。

参考：
- [Issue #3104: electron-builder does not copy directories named "node_modules" into my application](https://github.com/electron-userland/electron-builder/issues/3104)
- [Issue #3905: Copy node_modules from subdirectory](https://github.com/electron-userland/electron-builder/issues/3905)

さらに、Node.js の module resolution アルゴリズムは `node_modules` という名前のディレクトリのみを認識するため、`NODE_PATH` 環境変数だけでは ESM (ES Modules) の import を解決できないことも判明。

## 実装内容

### 採用した解決策：リネームによる回避方式

**フロー：**
1. **ビルド準備時**: `node_modules` → `n8n_modules` にリネーム
2. **パッケージング時**: electron-builder が `n8n_modules` を正常にコピー
3. **パック後**: `n8n_modules` → `node_modules` に戻す
4. **実行時**: Node.js が `node_modules` を正常に解決

### 変更ファイル

#### 1. `scripts/prepare-n8n.js`
npm install 後に `node_modules` を `n8n_modules` にリネームする処理を追加：

```javascript
// node_modules を n8n_modules にリネーム（electron-builder の制約回避）
const nodeModulesPath = path.join(n8nDistDir, 'node_modules');
const n8nModulesPath = path.join(n8nDistDir, 'n8n_modules');

if (fs.existsSync(nodeModulesPath)) {
  console.log('[prepare-n8n] Renaming node_modules to n8n_modules...');
  fs.renameSync(nodeModulesPath, n8nModulesPath);
  console.log('[prepare-n8n] Rename completed.');
}
```

#### 2. `scripts/after-pack.js` (新規作成)
electron-builder の afterPack hook として動作し、パッケージング後に `n8n_modules` を `node_modules` に戻す：

```javascript
exports.default = async function(context) {
  const { appOutDir } = context;
  const n8nDistDir = path.join(appOutDir, 'resources', 'n8n-dist');
  const n8nModulesPath = path.join(n8nDistDir, 'n8n_modules');
  const nodeModulesPath = path.join(n8nDistDir, 'node_modules');

  console.log('[after-pack] Renaming n8n_modules to node_modules...');
  fs.renameSync(n8nModulesPath, nodeModulesPath);
  console.log('[after-pack] Rename completed successfully!');
};
```

#### 3. `electron-builder.yml`
afterPack hook の設定を追加し、filter 指定を削除（全体をコピー）：

```yaml
extraResources:
  - from: n8n-dist
    to: n8n-dist
afterPack: ./scripts/after-pack.js
```

#### 4. `src/main/n8n-manager.ts`
n8n プロセス起動時に `cwd` を `n8n-dist` に設定：

```typescript
this.n8nProcess = fork(n8nCliPath, ['start'], {
  cwd: this.n8nInstallPath, // n8n-dist をカレントディレクトリに設定
  env: {
    // ...
    NODE_PATH: n8nModulesPath,
  },
  // ...
});
```

## 動作確認

### ビルド結果
```
[after-pack] Running afterPack hook...
[after-pack] Renaming n8n_modules to node_modules...
[after-pack] Rename completed successfully!
```

### パッケージング後のディレクトリ構造
```
release/0.1.0/win-unpacked/resources/n8n-dist/
├── node_modules/          ← 正常にリネームされた
├── package.json
└── package-lock.json
```

### 実行確認
- パッケージングされたアプリを起動
- n8n が正常に起動し、UI が表示されることを確認
- ウィンドウタイトル: "Workflows - n8n[DEV]"
- URL: `http://127.0.0.1:5678/home/workflows`
- ワークフロー作成機能が動作

## 結果
✅ electron-builder の `node_modules` 除外制約を回避
✅ パッケージングされたアプリで n8n が正常に起動・動作
✅ すべての機能が正常に動作することを確認

## 次の課題
特になし。この実装で問題は解決した。

## 参考資料
- [Application Contents - electron-builder](https://www.electron.build/contents.html)
- [Issue #867: Use of extraResources prevents node_modules from being included in asar](https://github.com/electron-userland/electron-builder/issues/867)
- [Issue #3104: electron-builder does not copy directories named "node_modules"](https://github.com/electron-userland/electron-builder/issues/3104)
- [Issue #3905: Copy node_modules from subdirectory](https://github.com/electron-userland/electron-builder/issues/3905)
