# 作業記録 2024-12-15 #1

## 作業概要
開発モード（`pnpm dev`）が動かなくなった問題を解決し、ジャンクション方式でより洗練された実装に改善。

## 背景・課題
`docs/report/20251214_1.md` で実装したリネーム方式により、本番ビルドは成功したが、開発モードで新たな問題が発生：
- `prepare-n8n.js` で `node_modules` → `n8n_modules` にリネームされたまま
- 開発モード起動時、`n8n-manager.ts` が `node_modules` を参照するため、見つからない

## 解決策の変遷

### 第1段階：環境変数による制御方式
開発時と本番時で異なる挙動を実装。

**実装内容:**
```javascript
// prepare-n8n.js
if (process.env.RENAME_NODE_MODULES === 'true') {
  // ビルド時のみリネーム
  fs.renameSync(nodeModulesPath, n8nModulesPath);
}
```

```json
// package.json
{
  "scripts": {
    "prepare:n8n:build": "cross-env RENAME_NODE_MODULES=true node scripts/prepare-n8n.js",
    "package": "npm run prepare:n8n:build && npm run build && electron-builder"
  }
}
```

**動作確認:**
- ✅ 開発モード: `node_modules` のまま使用
- ✅ 本番ビルド: リネーム → パッケージング → リネームバック

**問題点:**
- 環境変数の制御が必要
- スクリプトが複雑化

### 第2段階：ジャンクション（Junction）方式【最終採用】
ユーザーからの提案で、Windows のジャンクション機能を活用。

#### ジャンクションとは
- Windows NTFS の機能（ディレクトリのシンボリックリンク）
- **管理者権限不要**で作成可能（シンボリックリンクとの最大の違い）
- ディレクトリのみ（ファイルには使えない）
- ローカルディスク上のディレクトリのみ

#### 実装内容

**`scripts/prepare-n8n.js`:**
```javascript
// 1. 通常通り node_modules にインストール
execSync('npm install --omit=dev --no-optional', { cwd: n8nDistDir });

// 2. node_modules を n8n_modules にリネーム
fs.renameSync(nodeModulesPath, n8nModulesPath);

// 3. n8n_modules への node_modules ジャンクションを作成
fs.symlinkSync(n8nModulesPath, nodeModulesPath, 'junction');
```

**結果:**
```
n8n-dist/
├── n8n_modules/          ← 実体（890MB のパッケージ）
└── node_modules/         ← ジャンクション（n8n_modules へのリンク）
```

**`package.json`:**
```json
{
  "scripts": {
    "prepare:n8n": "node scripts/prepare-n8n.js",
    "package": "npm run prepare:n8n && npm run build && electron-builder"
  }
}
```
- `prepare:n8n:build` スクリプトを削除（環境変数が不要に）

**getAllFiles 関数の修正:**
```javascript
function getAllFiles(dirPath, arrayOfFiles = []) {
  const files = fs.readdirSync(dirPath);

  files.forEach(file => {
    const filePath = path.join(dirPath, file);
    const stats = fs.lstatSync(filePath); // シンボリックリンクを追跡しない

    // シンボリックリンク/ジャンクションはスキップ
    if (stats.isSymbolicLink()) {
      return;
    }

    if (stats.isDirectory()) {
      arrayOfFiles = getAllFiles(filePath, arrayOfFiles);
    } else {
      arrayOfFiles.push(filePath);
    }
  });

  return arrayOfFiles;
}
```

## ジャンクション方式のフロー

### 開発時
1. `npm run prepare:n8n` 実行
2. `n8n_modules` が実体として作成される
3. `node_modules` ジャンクションが作成される
4. Node.js は `node_modules` 経由で `n8n_modules` の内容を参照
5. 開発モード起動 → 正常動作 ✅

### ビルド時
1. `npm run package` 実行
2. `prepare:n8n` でジャンクション構造を作成
3. electron-builder が `extraResources` をコピー
   - `n8n_modules`（実体）はコピーされる
   - `node_modules`（ジャンクション）は**コピーされない**（重要！）
4. afterPack hook で `n8n_modules` → `node_modules` にリネーム
5. 最終的に `node_modules` が同梱される ✅

## ジャンクション方式の利点

| 項目 | 環境変数方式 | ジャンクション方式 |
|------|-------------|-------------------|
| 環境変数 | 必要 | **不要** ✅ |
| スクリプト数 | 2つ（prepare:n8n, prepare:n8n:build） | **1つ**（prepare:n8n）✅ |
| リネーム回数 | 2回（prepare + afterPack） | **1回**（afterPack のみ）✅ |
| 管理者権限 | 不要 | **不要**（ジャンクション）✅ |
| 実装の複雑さ | やや複雑 | **シンプル** ✅ |

## 動作確認

### 開発モード
```
pnpm dev
```
- ✅ n8n が正常に起動
- ✅ UI が表示（Workflows - n8n[DEV]）
- ✅ ワークフロー作成機能が動作

### 本番ビルド
```
pnpm package
```
**ログ出力:**
```
[prepare-n8n] Renaming node_modules to n8n_modules...
[prepare-n8n] Creating junction: node_modules -> n8n_modules...
[prepare-n8n] Junction created successfully.
[prepare-n8n] n8n_modules size: 890.60 MB

[after-pack] Running afterPack hook...
[after-pack] Renaming n8n_modules to node_modules...
[after-pack] Rename completed successfully!
```

**最終構造:**
```
release/0.1.0/win-unpacked/resources/n8n-dist/
├── node_modules/          ← 正常に同梱
├── package.json
└── package-lock.json
```

## 技術的な発見

### ジャンクション vs シンボリックリンク

| 機能 | ジャンクション | シンボリックリンク |
|------|--------------|-------------------|
| 管理者権限 | **不要** | 必要（または Developer Mode） |
| 対象 | ディレクトリのみ | ファイル・ディレクトリ両方 |
| パス | 絶対パスのみ | 相対・絶対パス両方 |
| Windows バージョン | 2000 以降 | Vista 以降 |
| Node.js 作成方法 | `fs.symlinkSync(target, path, 'junction')` | `fs.symlinkSync(target, path, 'dir')` |

### electron-builder のコピー挙動
- `extraResources` でディレクトリをコピーする際：
  - 実体（通常のディレクトリ）→ **コピーされる**
  - ジャンクション/シンボリックリンク → **コピーされない**
  - この挙動を利用して、`n8n_modules`（実体）のみをコピー

## 結果
✅ 開発モードと本番ビルドの両方で正常動作
✅ 環境変数不要でシンプルな実装に
✅ 管理者権限不要（Windows ジャンクション機能）
✅ electron-builder の node_modules 除外制約を完全に回避

## コミット履歴
- `9e4dc35` refactor: ジャンクション方式でnode_modules問題を解決
- `4768747` fix: 開発モードと本番ビルドの両対応を実現
- `2dfeb7c` chore: Phase 4 作業の残ファイルを整理
- `22e8705` fix: electron-builder の node_modules 除外問題を解決

## 参考資料
- Windows ジャンクションポイント: https://docs.microsoft.com/en-us/windows/win32/fileio/reparse-points
- Node.js fs.symlinkSync: https://nodejs.org/api/fs.html#fs_fs_symlinksync_target_path_type
- electron-builder extraResources: https://www.electron.build/configuration/contents.html#extraresources
