# Phase 5 実装作業記録 - 2025/12/16

## 作業概要
Phase 5: 快適性向上の実装
- バックグラウンド起動（Windowsシステムトレイ常駐）
- ポート設定メニューと永続化
- ポート競合時のセルフリカバリ

## 実装計画

### 1. 設定管理モジュール (config-manager.ts)
- `n8tive_config.json` の読み書き機能
- ポート番号の保存・読み込み
- 設定のリセット機能

### 2. システムトレイ機能
- Electron の Tray API を使用
- トレイアイコンとメニュー
- ウィンドウの表示/非表示切り替え

### 3. バックグラウンド常駐
- ウィンドウクローズ時にアプリを終了せずトレイに格納
- トレイメニューから終了可能

### 4. ポート設定機能
- Electronメニューに「設定」を追加
- ポート番号入力ダイアログ
- 「自動設定に戻す」オプション

### 5. ポート競合時の処理
- 指定ポートが使用中の場合のエラー表示
- 再設定を促すメッセージ

---

## 実装開始

### 1. 設定管理モジュール (config-manager.ts) の実装

`src/main/config-manager.ts` を作成しました。

**主な機能:**
- `n8tive_config.json` の読み込み・保存
- ポート番号の取得・設定・クリア
- 設定ファイルのリセット

設定ファイルは `app.getPath('userData')/n8tive_config.json` に保存されます。

### 2. システムトレイ機能の実装

`src/main/index.ts` にシステムトレイ機能を追加しました。

**実装内容:**
- n8nのfavicon.icoをコピーして `resources/tray-icon.ico` として使用
- トレイアイコンとメニューの作成
  - 「開く」: ウィンドウを表示
  - 「設定」サブメニュー:
    - 「ポート設定...」: ポート設定ダイアログを開く
    - 「自動設定に戻す」: ポート設定をクリアして自動探索に戻す
  - 「終了」: アプリを終了
- トレイアイコンのクリックでウィンドウの表示/非表示を切り替え

### 3. バックグラウンド常駐の実装

ウィンドウクローズ時の動作を変更しました。

**変更点:**
- `window.on('close')` でウィンドウを閉じる代わりに隠す
- `window-all-closed` イベントでアプリを終了しない
- トレイメニューの「終了」から明示的に終了可能

### 4. ポート設定ダイアログの実装

`src/renderer/port-settings.html` を作成し、ポート設定用のUIを実装しました。

**機能:**
- ポート番号入力フォーム (1024-65535の範囲)
- 現在の設定ポートの表示
- バリデーション
- 保存して再起動

**IPC API の追加 (`src/main/preload.ts`):**
- `getCurrentPort()`: 現在のポート設定を取得
- `savePortAndRestart(port)`: ポート設定を保存して再起動
- `closePortSettings()`: ダイアログを閉じる

### 5. N8nManagerのポート設定優先起動

`src/main/n8n-manager.ts` を修正しました。

**変更点:**
- `setPreferredPort(port)` メソッドを追加
- 起動時に優先ポートが設定されている場合はそのポートを使用
- 優先ポートが使用中の場合はエラーを投げる（自動フォールバックしない）
- 優先ポートが設定されていない場合は従来通り自動探索

**`src/main/port-finder.ts` の変更:**
- `checkPort()` 関数をエクスポートして外部から利用可能に

**`src/main/index.ts` の変更:**
- 起動時に設定ポートを読み込んで `n8nManager.setPreferredPort()` を呼び出し
- ポート設定保存時に `setPreferredPort()` を呼び出してから再起動

### 6. ポート競合時のエラーハンドリング

**実装内容:**
- 設定ポートが使用できない場合、エラーメッセージを表示
- エラーメッセージには「別のポートを選ぶか、自動設定に戻すよう」指示
- 「自動設定に戻す」機能では確認ダイアログを表示してから実行

### 7. electron-builder.yml の更新

トレイアイコンをビルドに含めるため、`resources/tray-icon.ico` を追加しました。

---

## 動作テスト開始

開発モードでアプリを起動し、Phase5の実装をテストします。

### 問題と修正

#### 問題1: ポート5678が既に使用中
**原因**: 前回のn8nプロセスが残っていた
**対処**: プロセスID 55556を終了

#### 問題2: ポート設定ダイアログが真っ白
**原因**: `electron.vite.config.ts`に`port-settings.html`が登録されていなかった
**対処**:
- `electron.vite.config.ts`のrenderer inputに`port-settings.html`を追加
- `showPortSettingsDialog()`で開発モードとビルドモードで異なるパスを使用
  - 開発モード: `http://localhost:5173/port-settings.html`
  - ビルドモード: ファイルパス

#### 問題3: n8nの警告メッセージ
**原因**: 推奨される環境変数が設定されていなかった
**対処**: `n8n-manager.ts`で以下の環境変数を設定
```
DB_SQLITE_POOL_SIZE=3
N8N_RUNNERS_ENABLED=true
N8N_BLOCK_ENV_ACCESS_IN_NODE=false
N8N_GIT_NODE_DISABLE_BARE_REPOS=true
```

#### 問題4: ポート設定ダイアログに無駄なスクロール
**原因**: パディング/マージンが大きすぎた
**対処**:
- bodyとcontainerのpaddingを削減（20px/24px → 0px/16px）
- 各要素のマージンを調整
- ダイアログウィンドウの高さを240pxに縮小
- `overflow: hidden`を設定

---

#### 問題5: アプリ終了時にn8nプロセスが残る
**原因**: トレイメニューから「終了」を選択した際、`isQuitting`フラグが先に設定されるため、`before-quit`イベントでn8nを停止せずに終了していた
**対処**:
- `quitApp()`関数を追加し、n8nを確実に停止してから終了するように修正
- トレイメニューの「終了」で`quitApp()`を呼び出すように変更
- `before-quit`イベントハンドラを簡略化
- `n8n-manager.ts`の`stop()`メソッドを改善：
  - 詳細なログ出力を追加
  - プロセス終了の確認を強化
  - タイムアウト処理の改善
**結果**: ✅ 解決。ポート競合エラーが表示されなくなった

#### 問題6: punycode非推奨警告が表示される
**原因**: n8n 1.123.5の依存パッケージ内で非推奨の`punycode`モジュールを使用している
**対処**:
1. **根本的解決**: n8nを1.123.5から2.0.2にバージョンアップ（`n8n-version.json`を更新）
2. **ログ記録の改善**: n8nの標準出力・標準エラー出力を1つのログファイルに時系列で記録
   - ファイル: `app.getPath('userData')/logs/n8n-YYYY-MM-DD.log`
   - 形式: `[timestamp] [STDOUT/STDERR] message`
   - 時系列で追跡可能で、標準出力とエラー出力を区別しやすい

**理由**:
- 警告のフィルタリングは対症療法であり、根本的な解決ではない
- n8nのバージョンアップにより、依存パッケージが更新されて警告が解消される可能性がある
- ログファイルに記録することで、起動時の警告を後から確認できるようになる

#### 問題7: punycode警告がエラーとして表示される
**原因**: n8n 2.0.2でもpunycode警告は発生していたが、`stderr`出力を`onError`コールバックに渡していたため、エラーとして表示されていた
**ユーザーからの指摘**: 「起動に失敗しなければ参考情報でしかない」
**対処**:
- `n8n-manager.ts`のstderr監視部分を修正
- `this.callbacks.onError?.(message)` の呼び出しを削除
- stderr出力は `this.callbacks.onLog?.(\`[STDERR] ${message}\`)` のみで参考情報として表示
- ログファイルには引き続き `[STDERR]` として記録

**結果**: ✅ 解決。警告が参考情報として表示され、エラー表示されなくなった

---

## Phase 5 実装完了

### テスト結果

すべての機能が正常に動作することを確認しました：

1. ✅ **システムトレイアイコン**: 正常に表示され、クリックでウィンドウの表示/非表示が切り替わる
2. ✅ **トレイメニュー**: 「開く」「設定」「終了」すべて正常に動作
3. ✅ **ポート設定ダイアログ**: レイアウトが適切で、スクロール不要
4. ✅ **ポート番号の変更**: 設定が保存され、再起動時に反映される
5. ✅ **バックグラウンド常駐**: ウィンドウを閉じてもアプリがトレイに常駐
6. ✅ **アプリ終了時のプロセス停止**: n8nプロセスが確実に停止し、ポート競合が発生しない
7. ✅ **stderr処理**: 警告がエラーではなく参考情報として表示される
8. ✅ **ログ記録**: stdout/stderrが統合ログファイルに時系列で記録される

### 実装済み機能一覧

- **設定管理**: `ConfigManager`クラスによる`n8tive_config.json`の読み書き
- **システムトレイ**: トレイアイコンとコンテキストメニュー
- **バックグラウンド常駐**: ウィンドウクローズ時もアプリ継続
- **ポート設定UI**: 専用ダイアログで設定変更可能
- **ポート設定永続化**: 設定の保存と次回起動時の適用
- **自動設定への復帰**: 確認ダイアログ付きでポート設定をクリア
- **ポート競合検出**: 設定ポートが使用中の場合はエラー表示
- **適切なプロセス管理**: 終了時の確実なn8nプロセス停止
- **ログファイル出力**: 日付別ログファイルへの統合記録

### 次のステップ

Phase 5の実装が完了しました。次は以下を実施します：
- メインドキュメントの更新（Phase 5完了の記録）
- 変更内容のGitコミット
