# 20251216_3: バージョニングスキーム変更の実装

## 作業概要
n8tive のバージョニングスキームを、ラッパー自体のバージョンとバンドルされた n8n のバージョンを明確に区別する形式に変更しました。SemVer ビルドメタデータを使用した自動バージョン生成の仕組みを実装。

## 背景と目的

### 課題
- 従来のバージョン `0.1.0` では、n8tive ラッパー自体のバージョンとバンドルされている n8n のバージョンが区別できなかった
- ユーザーがどのバージョンの n8n を使用しているか、About ダイアログから直接確認できなかった
- バージョン管理が手動で、package.json の編集が必要だった

### 解決策
SemVer 2.0.0 のビルドメタデータを活用した新しいバージョン形式を採用:
```
{n8tive-version}+n8n.{n8n-version}
```

例:
- `1.0.0+n8n.2.0.2` - n8tive 1.0.0、n8n 2.0.2 をバンドル
- `1.1.0+n8n.2.1.0` - n8tive 1.1.0、n8n 2.1.0 にアップデート

### メリット
1. **明確な区別**: ラッパーのバージョンと n8n のバージョンが一目で分かる
2. **自動化**: ビルド時に自動生成されるため、手動編集不要
3. **SemVer 準拠**: ビルドメタデータは正式な SemVer 仕様の一部
4. **正式リリース扱い**: `-` のプレリリース識別子と異なり、`+` のビルドメタデータは正式版として扱われる

## 設計決定事項

### 1. バージョン生成方式
**決定**: ビルド前スクリプト（`scripts/update-version.js`）で自動生成
- n8tive ベースバージョンはスクリプト内の定数 `N8TIVE_VERSION` で管理
- n8n バージョンは既存の `n8n-version.json` から読み取り
- セマンティックバージョニングの範囲記号（`^`, `~` など）を除去して結合
- `package.json` の `version` フィールドを自動更新

**理由**:
- 単一の真実の情報源（Single Source of Truth）を維持
- 手動編集のリスクを排除
- ビルドパイプラインに統合しやすい

### 2. 実行タイミング
**決定**: `pnpm package` の最初のステップとして実行
```json
"package": "npm run update:version && npm run prepare:n8n && npm run build && electron-builder"
```

**理由**:
- ビルドごとに常に最新のバージョンが反映される
- 手動実行も可能（`pnpm run update:version`）
- 既存のビルドパイプラインへの影響を最小化

### 3. バージョン形式
**決定**: `{major}.{minor}.{patch}+n8n.{n8n-version}` の厳格な形式

**理由**:
- SemVer 2.0.0 に完全準拠
- `+` はビルドメタデータであり、バージョン比較に影響しない
- n8tive のバージョンが優先され、n8n バージョンはメタデータとして扱われる

## 実装内容

### 1. `scripts/update-version.js` の作成

新規作成したバージョン生成スクリプト。

**主な機能**:
- `N8TIVE_VERSION` 定数の読み取りとバリデーション（SemVer 形式 `X.Y.Z` の検証）
- `n8n-version.json` の読み取りと JSON パース
- セマンティックバージョニング範囲記号の除去（正規表現 `/^[\^~>=<]+/`）
- n8n バージョンのバリデーション（基本形式 `X.Y.Z` または `X.Y.Z-prerelease` の検証）
- フルバージョン文字列の構築（`${N8TIVE_VERSION}+n8n.${n8nVersion}`）
- `package.json` の読み取り・更新・書き込み（2スペースインデント、末尾改行）

**エラーハンドリング**:
- n8n-version.json の存在確認
- JSON パースエラーのキャッチ
- バージョン形式の検証
- 詳細なエラーメッセージの出力
- エラー時の exit code 1

**ログ出力**:
```
[update-version] Starting version generation...
[update-version] Current n8tive version: 1.0.0
[update-version] Current n8n version: ^2.0.2
[update-version] Stripped n8n version: ^2.0.2 → 2.0.2
[update-version] Generated version: 1.0.0+n8n.2.0.2
[update-version] Updated package.json successfully
[update-version] Version changed: 0.1.0 → 1.0.0+n8n.2.0.2
[update-version] Version generation completed successfully!
```

### 2. `package.json` の更新

**変更内容**:
```json
{
  "version": "1.0.0+n8n.2.0.2",
  "scripts": {
    "update:version": "node scripts/update-version.js",
    "package": "npm run update:version && npm run prepare:n8n && npm run build && electron-builder"
  }
}
```

**追加したスクリプト**:
- `update:version`: バージョン生成スクリプトの単体実行コマンド
- `package`: ビルドパイプラインの最初のステップとして `update:version` を追加

### 3. ドキュメントの更新

#### `docs/00_ProjectPlan.md`
新規セクション「1.3 バージョニングポリシー」を追加:
- バージョン形式の説明
- 具体例（初回リリース、機能追加、バグフィックス）
- バージョン管理方法（定数とファイルの役割）
- バージョンアップ手順（n8n のみ、n8tive ラッパー）
- 表示場所（About ダイアログ、ビルド出力ディレクトリ）

#### `docs/05_BuildPackaging.md`
2箇所を更新:
1. 冒頭の package.json 例にコメント追加:
   ```json
   "version": "1.0.0+n8n.2.0.2",  // Auto-generated, do not edit manually
   ```
2. 新規セクション「バージョン管理の自動化」を追加:
   - update-version.js の役割と処理フロー（5ステップ）
   - ビルドパイプラインへの統合方法
   - バージョンアップ方法（n8n のみ、n8tive ラッパー）

#### `docs/02_ImplementationDetails.md`
新規セクション「`scripts/update-version.js`」を追加:
- スクリプトの目的と処理内容
- SemVer ビルドメタデータ形式の説明
- 自動実行の仕組み

## テスト結果

### 単体テスト
```bash
$ node scripts/update-version.js
[update-version] Starting version generation...
[update-version] Current n8tive version: 1.0.0
[update-version] Current n8n version: ^2.0.2
[update-version] Stripped n8n version: ^2.0.2 → 2.0.2
[update-version] Generated version: 1.0.0+n8n.2.0.2
[update-version] Updated package.json successfully
[update-version] Version changed: 0.1.0 → 1.0.0+n8n.2.0.2
[update-version] Version generation completed successfully!
```

✅ package.json のバージョンが `0.1.0` から `1.0.0+n8n.2.0.2` に正常に更新された

### バージョン形式の検証
- ✅ SemVer ビルドメタデータ形式に準拠
- ✅ n8tive バージョン（1.0.0）と n8n バージョン（2.0.2）が明確に区別
- ✅ 範囲記号（`^`）が正しく除去された

## 影響範囲

### 変更されたファイル
1. `scripts/update-version.js` (新規作成) - 113行
2. `package.json` (編集) - scripts セクションと version フィールド
3. `docs/00_ProjectPlan.md` (編集) - セクション 1.3 追加
4. `docs/05_BuildPackaging.md` (編集) - 2箇所更新
5. `docs/02_ImplementationDetails.md` (編集) - 1セクション追加

### 変更されないファイル
- 既存のソースコード（`src/` 以下）には変更なし
- `app.getVersion()` が自動的に新しいバージョンを返すため、About ダイアログも自動対応
- ビルド設定（`electron-builder.yml`）は変更不要

## 今後の作業

### 残りのタスク
1. ✅ スクリプト作成
2. ✅ 単体テスト
3. ✅ package.json 更新
4. ⏳ フルビルドパイプラインのテスト（`pnpm package`）
5. ✅ ドキュメント更新
6. ⏳ Git コミット作成

### 次のステップ
1. `pnpm package` でフルビルドをテストし、以下を確認:
   - バージョン生成が自動実行される
   - ビルド出力ディレクトリ名に新しいバージョンが使用される（`release/1.0.0+n8n.2.0.2/`）
   - アプリケーションの About ダイアログに新しいバージョンが表示される
2. すべてのテストが成功したら Git コミットを作成

## 技術的詳細

### SemVer ビルドメタデータについて
- SemVer 2.0.0 仕様: https://semver.org/#spec-item-10
- ビルドメタデータは `+` で始まる
- バージョン優先順位の比較には影響しない
- 正式リリース版として扱われる（プレリリースではない）

### バージョン比較の挙動
```
1.0.0+n8n.2.0.2 === 1.0.0+n8n.2.1.0 === 1.0.0 (比較において)
1.0.0+n8n.2.0.2 < 1.0.1+n8n.2.0.2
1.0.0+n8n.2.0.2 < 1.1.0+n8n.2.0.2
```

これは意図的な設計であり、n8tive ラッパーのバージョンが優先され、n8n バージョンはメタデータとして扱われる。

### エッジケース対応
スクリプトは以下のエッジケースに対応:
- `^2.0.2` → `2.0.2` (キャレット除去)
- `~2.0.2` → `2.0.2` (チルダ除去)
- `>=2.0.0` → `2.0.0` (以上記号除去)
- `2.0.2-beta.1` → `2.0.2-beta.1` (プレリリース版も対応)

## まとめ

バージョニングスキームの変更により、以下が実現されました:

1. **透明性**: ユーザーが使用している n8n のバージョンが About ダイアログから一目で分かる
2. **保守性**: バージョン管理が自動化され、手動編集のミスを防止
3. **明確性**: ラッパーと n8n のバージョンが明確に区別される
4. **標準準拠**: SemVer 2.0.0 に完全準拠した形式

この変更により、n8tive プロジェクトのバージョン管理がより堅牢で明確になりました。

## Git コミットメッセージ (案)

```
feat: implement build metadata versioning scheme

- Add scripts/update-version.js for automatic version generation
- Update package.json to include update:version script
- Integrate version update into build pipeline
- Document versioning policy in project documentation
- Use SemVer build metadata format: 1.0.0+n8n.2.0.2

This change clearly separates the n8tive wrapper version from
the bundled n8n version, making it transparent to users which
version of n8n they are using.
```
