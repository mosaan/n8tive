# 20251216_4: GitHub Releases 公開設定の実装

## 作業概要
electron-builder を使用した GitHub Releases への自動公開機能を実装。ドラフトリリースによる安全な公開ワークフローを構築し、包括的なリリースプロセスドキュメントを作成しました。

## 背景と目的

### 課題
- n8tive のリリース版を配布する仕組みが未整備
- ユーザーが最新版をダウンロードする公式な場所がない
- 将来の自動更新機能の基盤が必要
- ビルドアーティファクトの管理が手動で煩雑

### 解決策
electron-builder の GitHub Releases 統合を活用:
- **無料ホスティング**: GitHub が提供する無制限ストレージ
- **ドラフトレビュー**: 公開前に手動確認可能
- **自動更新対応**: latest.yml の自動生成
- **シンプルな認証**: Fine-grained Personal Access Token

### メリット
1. **安全性**: ドラフトリリースで公開前にレビュー可能
2. **利便性**: コマンド一つで自動アップロード
3. **拡張性**: 将来的に GitHub Actions で完全自動化可能
4. **標準化**: electron-builder の推奨方法に準拠

## 設計決定事項

### 1. GitHub Releases を選択した理由
**他の選択肢**:
- S3 + CloudFront: コスト発生、設定複雑
- 独自サーバー: 運用負担、帯域幅制限
- Generic Provider: カスタム実装が必要

**GitHub Releases の優位性**:
- 無料（パブリックリポジトリ）
- electron-builder との完璧な統合
- ユーザーにとって馴染みのあるUI
- Git タグとの連携
- 自動更新機能のサポート

### 2. ドラフトリリース戦略
**決定**: `releaseType: draft` をデフォルトに設定

**理由**:
- 320MB のインストーラーを公開前に検証できる
- リリースノートを追加する時間的余裕
- 誤った公開を防止
- アーティファクトの整合性を確認可能

**ワークフロー**:
1. ローカルでビルド・アップロード
2. GitHub でドラフトを確認
3. リリースノートを追加
4. 手動で公開

### 3. 認証方式
**決定**: Fine-grained Personal Access Token

**設定**:
- スコープ: 単一リポジトリ（mosaan/n8tive）のみ
- 権限: Contents の Read and write のみ
- 有効期限: 90 日（更新リマインダー推奨）
- 環境変数: `GH_TOKEN`

**Classic Token との比較**:
| 項目 | Fine-grained | Classic |
|------|--------------|---------|
| スコープ | リポジトリ単位 | 全リポジトリ |
| 権限 | 最小限に制限可能 | 広範な権限 |
| 有効期限 | カスタマイズ可能 | 無期限または固定期間 |
| セキュリティ | ✅ 高い | ⚠️ 低い |

### 4. 公開ファイル
**自動アップロードされるファイル**:
1. `n8tive Setup {version}.exe` (~320MB) - NSIS インストーラー
2. `n8tive Setup {version}.exe.blockmap` - 差分更新メタデータ
3. `latest.yml` - 自動更新設定ファイル

**latest.yml の内容例**:
```yaml
version: 1.0.0
files:
  - url: n8tive-Setup-1.0.0.exe
    sha512: <hash>
    size: 319771767
path: n8tive-Setup-1.0.0.exe
sha512: <hash>
releaseDate: '2025-12-16T10:49:38.261Z'
```

### 5. バージョンタグ形式
**決定**: `vPrefixedTagName: true`

**タグ形式**: `v1.0.0+n8n.2.0.2`
- `v` プレフィックス付き
- SemVer ビルドメタデータを含む完全なバージョン
- GitHub が `+` 文字をサポート

**ファイル名**: `n8tive Setup 1.0.0.exe`
- ベースバージョンのみ（簡略化）
- Windows ファイル名の互換性を確保

## 実装内容

### 1. electron-builder.yml の更新

**追加した設定**:
```yaml
# Publishing Configuration
publish:
  provider: github
  owner: mosaan
  repo: n8tive
  releaseType: draft
  vPrefixedTagName: true
  publishAutoUpdate: true
```

**各オプションの説明**:
- `provider: github` - GitHub Releases を使用
- `owner: mosaan` - GitHub ユーザー名
- `repo: n8tive` - リポジトリ名
- `releaseType: draft` - ドラフトとして作成
- `vPrefixedTagName: true` - タグに `v` を付与
- `publishAutoUpdate: true` - latest.yml をアップロード

### 2. package.json の更新

**追加したスクリプト**:
```json
{
  "scripts": {
    "package:publish": "npm run update:version && npm run prepare:n8n && npm run build && electron-builder --publish always"
  }
}
```

**実行フロー**:
1. `update:version` - バージョン文字列を自動生成
2. `prepare:n8n` - n8n 依存関係を準備
3. `build` - Electron アプリをビルド
4. `electron-builder --publish always` - GitHub にアップロード

**`--publish` オプション**:
- `always` - 常に公開（ドラフト作成）
- `onTag` - タグが存在する場合のみ
- `onTagOrDraft` - タグまたはドラフトが存在する場合
- `never` - 公開しない（ビルドのみ）

### 3. .gitignore の更新

**追加したエントリ**:
```gitignore
# GitHub token backup (never commit)
gh_token.txt
```

**既存の保護**:
- `.env` ファイルは既に除外済み
- トークンの誤コミットを防止

### 4. docs/07_ReleaseProcess.md の作成

**新規作成した包括的なドキュメント** (~350行):

**セクション構成**:
1. **概要** - リリースプロセスの説明
2. **前提条件** - トークン作成と環境変数設定
3. **リリース手順** - 2つのオプション（ドラフト/タグベース）
4. **バージョニング方式** - 形式と例
5. **公開されるファイル** - アップロードされるアーティファクト
6. **トラブルシューティング** - よくある問題と解決策
7. **ベストプラクティス** - 推奨事項
8. **自動更新の設定** - latest.yml の役割
9. **GitHub Actions** - 将来の自動化
10. **セキュリティ考慮事項** - トークン管理とリリース整合性
11. **リリース後の作業** - 動作確認と監視
12. **ロールバック戦略** - 問題発生時の対応

**実用的な内容**:
- PowerShell コマンド例
- トークン生成手順（スクリーンショット不要の明確な指示）
- エラーメッセージと解決策
- チェックリスト形式の手順

### 5. docs/05_BuildPackaging.md の更新

**追加したセクション**: "GitHub Releases の公開設定"

**内容**:
- electron-builder.yml の publish 設定の説明
- 各オプションの詳細解説
- 前提条件（トークン、環境変数）
- 公開手順（PowerShell コマンド）
- 公開されるファイルのリスト
- docs/07_ReleaseProcess.md への参照リンク

### 6. docs/00_ProjectPlan.md の更新

**追加した Phase 8**:
```markdown
- **Phase 8: リリース配布とオートアップデート** ✅ 完了 –
  electron-builder の GitHub Releases 連携を設定。
  ドラフトリリースを作成し、手動レビュー後に公開できるワークフロー。
  GH_TOKEN による認証、自動更新用 latest.yml の生成。
  詳細は `docs/07_ReleaseProcess.md` を参照。
```

## 使用方法

### トークンの設定

```powershell
# PowerShell でトークンを設定
$env:GH_TOKEN = "ghp_your_token_here"

# 確認
echo $env:GH_TOKEN
```

### リリースの作成

```powershell
# ビルドして GitHub に公開（ドラフト作成）
pnpm package:publish
```

**期待される出力**:
```
[update-version] Generated version: 1.0.0+n8n.2.0.2
[prepare-n8n] Using n8n version: 2.0.2
[after-pack] Renaming n8n_modules to node_modules...
Publishing to GitHub Releases...
Draft release created: v1.0.0+n8n.2.0.2
```

### GitHub でのレビュー

1. https://github.com/mosaan/n8tive/releases にアクセス
2. ドラフトリリースを確認
3. アップロードされた3つのファイルを検証
4. リリースノートを追加
5. "Publish release" をクリック

## 技術的詳細

### electron-builder の publish メカニズム

**内部動作**:
1. ビルド完了後、`afterPack` フックを実行
2. `publish` 設定を読み取り
3. GitHub API に認証（GH_TOKEN）
4. リリースを作成（またはドラフト作成）
5. アーティファクトをアップロード
6. latest.yml を生成・アップロード

**GitHub API エンドポイント**:
- `POST /repos/{owner}/{repo}/releases` - リリース作成
- `POST /repos/{owner}/{repo}/releases/{id}/assets` - アセットアップロード

### latest.yml の生成

**目的**: 自動更新機能のメタデータ

**内容**:
- バージョン番号
- ダウンロードURL
- ファイルサイズ
- SHA512 ハッシュ（整合性検証）
- リリース日時

**将来の使用**: electron-updater による自動更新

### バージョンタグの処理

**electron-builder の動作**:
1. package.json から version を読み取り（`1.0.0+n8n.2.0.2`）
2. `vPrefixedTagName: true` により `v` を付与
3. タグ `v1.0.0+n8n.2.0.2` を作成（または使用）
4. リリースタイトルとして使用

**GitHub での表示**:
- タグ名: `v1.0.0+n8n.2.0.2`
- リリースタイトル: `v1.0.0+n8n.2.0.2`
- ファイル名: `n8tive Setup 1.0.0.exe`

## テスト計画

### 実施すべきテスト

**Phase 1: ローカルビルドテスト**
- [ ] `pnpm package` がエラーなく完了
- [ ] `release/{version}/` に3つのファイルが生成
- [ ] latest.yml の内容が正しい（SHA512、サイズ）
- [ ] インストーラーがローカルで動作

**Phase 2: トークン設定テスト**
- [ ] GH_TOKEN 環境変数が設定可能
- [ ] トークンの権限が正しい（Contents: Read and write）
- [ ] トークンがリポジトリにアクセス可能

**Phase 3: ドラフト作成テスト**
- [ ] `pnpm package:publish` が成功
- [ ] GitHub にドラフトリリースが作成される
- [ ] 3つのファイルがすべてアップロードされる
- [ ] ファイルサイズがローカルと一致
- [ ] SHA512 ハッシュが一致

**Phase 4: リリース公開テスト**
- [ ] ドラフトを編集できる
- [ ] リリースノートを追加できる
- [ ] "Publish release" で公開できる
- [ ] Git タグが自動作成される
- [ ] ダウンロードリンクが有効

**Phase 5: エラーハンドリングテスト**
- [ ] トークンなしでエラーメッセージが表示
- [ ] 無効なトークンで適切にエラー処理
- [ ] ネットワークエラー時の挙動
- [ ] 既存リリースとの競合処理

## セキュリティ考慮事項

### トークン管理

**ベストプラクティス**:
1. Fine-grained token を使用
2. 最小権限の原則（Contents のみ）
3. 有効期限を設定（90日推奨）
4. 環境変数でのみ保存
5. パスワードマネージャーで管理
6. 定期的なローテーション

**禁止事項**:
- ❌ Git にコミット
- ❌ 平文ファイルで保存
- ❌ チャットツールで共有
- ❌ Classic token の使用（広範な権限）

### リリース整合性

**検証手順**:
1. ローカルビルドの SHA512 を記録
2. アップロード後、GitHub の latest.yml を確認
3. ハッシュ値が一致することを確認
4. ダウンロードしたファイルのハッシュを検証

**将来の強化**:
- コード署名証明書の取得
- Windows SmartScreen 対策
- SHA256 ハッシュの併用
- GPG 署名の追加

## 将来の拡張

### Phase 2: GitHub Actions 自動化

**実装内容** (準備済み):
- `.github/workflows/release.yml` の作成
- タグプッシュでトリガー
- Windows runner でビルド
- 自動的に GitHub Releases に公開

**メリット**:
- ローカルトークン不要
- 一貫したビルド環境
- リリースログの監査証跡
- 開発者の手間削減

### Phase 3: 自動更新機能

**実装内容**:
- `electron-updater` の統合
- アプリ内更新通知
- バックグラウンド差分ダウンロード
- ユーザーの明示的な承認後に更新

**要件**:
- latest.yml が公開されている（実装済み）
- コード署名（推奨）
- 更新UI の実装
- ロールバック機能

### Phase 4: マルチチャンネル

**チャンネル戦略**:
- `latest` - 安定版（デフォルト）
- `beta` - ベータ版（オプトイン）
- `alpha` - アルファ版（開発者のみ）

**設定例**:
```yaml
publish:
  - provider: github
    channel: latest
    releaseType: release
  - provider: github
    channel: beta
    releaseType: prerelease
```

## 影響範囲

### 変更されたファイル
1. `electron-builder.yml` (編集) - publish セクション追加
2. `package.json` (編集) - package:publish スクリプト追加
3. `.gitignore` (編集) - gh_token.txt を除外
4. `docs/07_ReleaseProcess.md` (新規作成) - 350行の詳細ドキュメント
5. `docs/05_BuildPackaging.md` (編集) - GitHub Releases セクション追加
6. `docs/00_ProjectPlan.md` (編集) - Phase 8 追加

### 変更されないファイル
- 既存のソースコード（`src/` 以下）
- ビルドスクリプト（`scripts/` 以下）
- ビルド出力（`release/` 以下）

## パフォーマンスと費用

### アップロード時間
- ファイルサイズ: 約 320MB
- 推定時間: 5-15分（接続速度による）
- 3ファイルの合計: 約 320MB + 数KB

### GitHub ストレージ
- パブリックリポジトリ: 無制限
- プライベートリポジトリ: プランによる
- 帯域幅: 無制限
- リリース数: 無制限

### ビルド時間
- ローカルビルド: 約 5-10分
- GitHub Actions: 約 15-20分（将来）

## トラブルシューティング

### よくある問題と解決策

**1. "No GitHub token found"**
```powershell
# 解決策
$env:GH_TOKEN = "ghp_your_token_here"
```

**2. "HTTP 403 Forbidden"**
- トークンの有効期限を確認
- 権限（Contents: Read and write）を確認
- リポジトリアクセスを確認

**3. "Release already exists"**
- GitHub でドラフトを削除
- またはバージョン番号をインクリメント

**4. アップロードが途中で止まる**
- ネットワーク接続を確認
- ドラフトリリースは再試行可能
- 手動アップロードも可能

## まとめ

GitHub Releases 公開設定の実装により、以下が実現されました:

1. **安全な公開**: ドラフトレビュープロセス
2. **自動化**: コマンド一つで公開可能
3. **セキュリティ**: Fine-grained token による認証
4. **拡張性**: 将来の自動更新・GitHub Actions 対応
5. **ドキュメント**: 包括的なリリースガイド

これにより、n8tive の初回公開リリースの準備が整いました。

## 次のステップ

1. ✅ GitHub Releases 設定完了
2. ⏳ トークン作成とテスト
3. ⏳ 初回ドラフトリリースの作成
4. ⏳ リリースノート作成
5. ⏳ 初回公開リリース（v1.0.0+n8n.2.0.2）

## Git コミットメッセージ (案)

```
feat: add GitHub Releases publishing configuration

- Configure electron-builder for GitHub Releases publishing
- Add package:publish script for manual draft releases
- Create comprehensive release process documentation
- Set up secure token authentication workflow
- Use draft releases for safe review process
- Update build documentation with publish instructions

Releases will be published at:
https://github.com/mosaan/n8tive/releases

Files added/modified:
- electron-builder.yml: Add publish configuration
- package.json: Add package:publish script
- .gitignore: Exclude token files
- docs/07_ReleaseProcess.md: Comprehensive release guide
- docs/05_BuildPackaging.md: Publish instructions
- docs/00_ProjectPlan.md: Add Phase 8 status
```
