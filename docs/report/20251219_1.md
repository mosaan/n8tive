# 20251219_1: GitHub Token セキュア管理の実装

## 作業概要
GitHub Personal Access Token を安全に管理するための `.env` ファイル方式を実装。リリースプロセスのセキュリティと利便性を向上させました。

## 背景と課題

### Phase 8 完了後の状況
前回（20251216_4）で GitHub Releases への公開機能を実装しましたが、トークン管理方法が明確でなく、以下の課題がありました:

1. **セキュリティリスク**: トークンを直接コマンドラインや環境変数に設定する方法のみが提示されていた
2. **利便性の欠如**: リリースのたびに手動でトークンを設定する必要がある
3. **誤コミットリスク**: トークンを平文ファイルに保存する危険性

### ユーザーの要望
「GitHub の PAT（Personal Access Token）は用意したが、どうやって設定するのがセキュアでいいか？」

## 設計決定事項

### 1. .env ファイル方式を推奨

**選択肢の比較**:
| 方式 | セキュリティ | 利便性 | Git安全性 | 推奨度 |
|------|------------|--------|-----------|--------|
| .env ファイル | ⭐⭐⭐ | ⭐⭐⭐ | ✅ (.gitignore済) | 🥇 推奨 |
| ユーザー環境変数 | ⭐⭐ | ⭐⭐⭐ | ✅ | 🥈 代替 |
| セッション変数 | ⭐ | ⭐ | ✅ | 🥉 一時用 |
| Windows Credential Manager | ⭐⭐⭐ | ⭐ | ✅ | 上級者向け |

**決定**: `.env` ファイル + 読み込みスクリプト

**理由**:
- プロジェクト単位で管理できる（他のプロジェクトに影響しない）
- `.gitignore` で既に除外されている（安全）
- PowerShell スクリプトで簡単に読み込める
- 一般的な開発者に馴染みのある方式
- トークンのローテーション（更新）が容易

### 2. .env.example テンプレートの提供

**方針**:
- Git 管理下に `.env.example` を配置
- 実際の `.env` は Git 除外（`.gitignore` で保護済み）

**メリット**:
- 新規開発者が必要な設定項目を把握できる
- 誤ってプレースホルダーのまま実行するのを防止
- ドキュメントとしても機能

### 3. 検証機能付きスクリプト

**set-gh-token.ps1 の機能**:
1. `.env` ファイルの存在確認
2. コメント行・空行のスキップ
3. `KEY=VALUE` 形式のパース
4. 環境変数への設定
5. トークンの検証（プレースホルダーチェック）
6. 分かりやすいエラーメッセージ

**エラーハンドリング**:
- `.env` が存在しない → セットアップ手順を表示
- トークンがプレースホルダーのまま → 警告を表示
- 読み込み成功 → 次のコマンドを案内

## 実装内容

### 1. .env.example の作成

**ファイル**: `.env.example`

```env
# GitHub Personal Access Token for publishing releases
# Copy this file to .env and set your actual token
# Get your token from: https://github.com/settings/tokens?type=beta
#
# Required permissions:
# - Repository: mosaan/n8tive (only)
# - Contents: Read and write
#
GH_TOKEN=ghp_your_token_here
```

**特徴**:
- トークン取得先の URL を明記
- 必要な権限を明示
- 分かりやすいコメント

### 2. scripts/set-gh-token.ps1 の作成

**主要機能**:

```powershell
# .env ファイルのパス解決
$envFile = Join-Path $PSScriptRoot ".." ".env"

# 存在確認
if (-not (Test-Path $envFile)) {
    # エラーメッセージとセットアップ手順を表示
}

# .env ファイルのパース
Get-Content $envFile | ForEach-Object {
    # コメント・空行をスキップ
    if ($_ -match '^\s*#' -or $_ -match '^\s*$') { return }

    # KEY=VALUE を抽出
    if ($_ -match '^([^=]+)=(.*)$') {
        $key = $matches[1].Trim()
        $value = $matches[2].Trim()
        # クォート除去
        $value = $value -replace '^["'']|["'']$', ''
        # 環境変数に設定
        Set-Item -Path "env:$key" -Value $value
    }
}

# 検証
if ($env:GH_TOKEN -eq "ghp_your_token_here") {
    # プレースホルダー警告
}
```

**エラーメッセージの工夫**:
- 色分け（Red: エラー、Yellow: 警告、Green: 成功、Cyan: 情報）
- 具体的な手順を番号付きで表示
- 次に何をすべきかを明示

### 3. RELEASE_SETUP.md の作成

**目的**: 初めてリリースする人向けのクイックスタートガイド

**内容**:
1. GitHub Personal Access Token の作成手順
2. `.env` ファイルの作成と設定
3. 動作確認方法
4. リリース実行の基本フロー
5. セキュリティ注意事項

**特徴**:
- 詳細な `docs/07_ReleaseProcess.md` へのリンク
- 最小限の手順で動作確認まで完了
- コピペで実行できるコマンド例

### 4. docs/07_ReleaseProcess.md の更新

**変更内容**:

**Before**:
- 方法1: 現在のセッションのみ（PowerShell）
- 方法2: 永続的な設定（ユーザー環境変数）

**After**:
- 方法1: .env ファイル（推奨） ⭐ NEW
- 方法2: 現在のセッションのみ（PowerShell）
- 方法3: 永続的な設定（ユーザー環境変数）

**リリース手順も更新**:
```powershell
# Before
$env:GH_TOKEN = "your_token_here"
pnpm package:publish

# After（推奨）
. .\scripts\set-gh-token.ps1
pnpm package:publish

# After（代替）
$env:GH_TOKEN = "your_token_here"
pnpm package:publish
```

## 動作確認

ユーザーによる実際の動作確認が行われ、以下が確認されました:

### 成功した項目
✅ `.env` ファイルからトークンが正しく読み込まれる
✅ GitHub Releases へのアップロードが成功
✅ ドラフトリリースが作成される
✅ インストーラーファイル（約 320MB）がアップロードされる

### 確認された仕様
📋 **リリース名**: `1.0.0`（ビルドメタデータ `+n8n.2.0.2` は表示されない）

**原因**: electron-builder の標準動作
- SemVer のビルドメタデータ（`+` 以降）はタグ名やリリース名から除外される
- これは electron-builder の仕様に準拠した動作

**判断**:
electron-builder の標準動作を尊重し、無理にカスタマイズしないことに決定。

**理由**:
- 標準的な振る舞いに従うことで将来の保守性を確保
- ユーザーはファイル名やリリースノートで n8n バージョンを確認可能
- タグ自体には完全なバージョン情報が含まれる（`v1.0.0+n8n.2.0.2`）

## 技術的詳細

### PowerShell スクリプトの工夫

#### 1. 相対パスの解決
```powershell
$envFile = Join-Path $PSScriptRoot ".." ".env"
```
スクリプトの場所に関わらず、プロジェクトルートの `.env` を参照

#### 2. 正規表現による柔軟なパース
```powershell
if ($_ -match '^\s*#' -or $_ -match '^\s*$') { return }
```
コメント行（`#` で始まる）と空行をスキップ

#### 3. クォート除去
```powershell
$value = $value -replace '^["'']|["'']$', ''
```
`GH_TOKEN="value"` や `GH_TOKEN='value'` の両方に対応

#### 4. ドット ソーシング
```powershell
. .\scripts\set-gh-token.ps1
```
現在のセッションで実行し、環境変数を引き継ぐ

### .gitignore の保護

既存の設定により、以下がすべて Git から除外されます:
```gitignore
.env
.env.local
.env.*.local
gh_token.txt
```

トークンの誤コミットを多重に防止。

### セキュリティ考慮事項

**保護されるもの**:
- ✅ `.env` ファイル（Git 除外）
- ✅ 環境変数（プロセス終了で消失）
- ✅ トークンのスコープ（単一リポジトリのみ）

**保護されないもの**:
- ⚠️ プロセスメモリ（実行中はメモリに存在）
- ⚠️ コマンド履歴（手動設定時）

**推奨事項**:
1. Fine-grained token を使用（Classic token は避ける）
2. 最小権限（Contents: Read and write のみ）
3. 有効期限を設定（90 日推奨）
4. 定期的なローテーション

## ファイル変更一覧

### 新規作成
1. `.env.example` - トークン設定テンプレート（Git 管理）
2. `scripts/set-gh-token.ps1` - トークン読み込みスクリプト
3. `RELEASE_SETUP.md` - クイックセットアップガイド

### 更新
4. `docs/07_ReleaseProcess.md` - .env 方式を推奨方法として追加

### 変更なし
- `.gitignore` - 既に `.env` が除外されている（追加不要）
- `electron-builder.yml` - 変更なし
- `package.json` - 変更なし

## 使用方法

### 初回セットアップ

```powershell
# 1. .env ファイルを作成
Copy-Item .env.example .env

# 2. .env を編集してトークンを設定
notepad .env
# → GH_TOKEN=ghp_あなたのトークン

# 3. 動作確認
. .\scripts\set-gh-token.ps1
```

### リリース時

```powershell
# トークンを読み込む
. .\scripts\set-gh-token.ps1

# ビルドして公開
pnpm package:publish
```

## 今後の改善案

### 検討項目

1. **トークンの有効期限アラート**
   - スクリプトでトークンの有効期限を確認
   - 期限が近い場合に警告表示

2. **GitHub CLI (gh) との統合**
   - `gh auth token` でトークンを取得
   - .env ファイル不要にする選択肢

3. **CI/CD との統合**
   - GitHub Actions で Secrets を使用
   - ローカルとCI で同じワークフローを実現

4. **マルチ環境対応**
   - `.env.production`, `.env.staging` など
   - 環境ごとに異なるトークンを使用

これらは必要に応じて実装を検討。

## まとめ

GitHub Personal Access Token の安全な管理方法として、`.env` ファイル + 読み込みスクリプト方式を実装しました。

**達成されたこと**:
1. ✅ セキュアなトークン管理（Git 除外、環境変数）
2. ✅ 利便性の向上（一度設定すれば再利用可能）
3. ✅ 分かりやすいセットアップガイド
4. ✅ エラーハンドリングと検証機能
5. ✅ 実際の動作確認完了

**electron-builder の仕様について**:
- リリース名に SemVer ビルドメタデータ（`+n8n.2.0.2`）は表示されない
- これは標準動作であり、無理にカスタマイズせず尊重する

これにより、n8tive のリリースプロセスがより安全で使いやすくなりました。

## 次のステップ（将来）

1. ✅ GitHub Token セキュア管理（完了）
2. ⏳ 初回公開リリース（v1.0.0）
3. ⏳ ユーザーフィードバックの収集
4. ⏳ 自動更新機能の実装（Phase 9）
5. ⏳ GitHub Actions による自動リリース

## Git コミットメッセージ（案）

```
feat: implement secure GitHub token management with .env

- Add .env.example template for token configuration
- Create set-gh-token.ps1 script with validation
- Add RELEASE_SETUP.md quick start guide
- Update release process docs with .env method

Security improvements:
- .env file is git-ignored (already configured)
- Script validates token before use
- Clear error messages guide users through setup
- Supports token rotation without code changes

Verified working:
- Token loads from .env successfully
- GitHub Releases upload works as expected
- Draft release created with v1.0.0

Note: electron-builder strips SemVer build metadata (+n8n.x.x.x)
from release names by design. This is standard behavior and we
respect it rather than implementing workarounds.

Files added:
- .env.example: Token configuration template
- scripts/set-gh-token.ps1: Secure token loader
- RELEASE_SETUP.md: Quick setup guide

Files modified:
- docs/07_ReleaseProcess.md: Add .env method as recommended
```
