# Corporate Network Support Implementation Report

**Date**: 2025-12-25  
**Task**: Enable n8tive to work behind corporate networks with proxy and CA certificate support

## Summary

Implemented comprehensive network configuration support for n8tive to enable operation behind corporate networks (e.g., environments using Zscaler or enterprise proxies). The implementation allows users to configure:

1. **HTTP/HTTPS Proxy Settings** - for routing outbound traffic through corporate proxies
2. **Custom CA Certificates** - for environments with SSL inspection (e.g., Zscaler)

## Technical Approach

### Key Finding: No Modification to n8n Required

Research confirmed that n8n fully supports proxy and CA certificate configuration through standard environment variables:

- **Proxy**: `HTTP_PROXY`, `HTTPS_PROXY`, `NO_PROXY`, `ALL_PROXY` (via `proxy-from-env` package)
- **CA Certificates**: `NODE_EXTRA_CA_CERTS` (standard Node.js environment variable)

This means we can achieve full corporate network support **without modifying the bundled n8n**.

### Implementation Strategy

1. Store proxy/CA settings in n8tive's configuration file (`n8tive_config.json`)
2. Pass settings as environment variables when forking the n8n process
3. Configure Electron session proxy for the BrowserWindow (n8n Editor UI)
4. Provide a user-friendly settings dialog for configuration

## Files Modified

### `src/main/config-manager.ts`
- Added `ProxyConfig` interface (enabled, server, bypass)
- Added `CACertConfig` interface (enabled, path)
- Extended `N8tiveConfig` to include proxy and CA certificate settings
- Added methods: `getProxy()`, `setProxy()`, `getCACert()`, `setCACert()`, `getNetworkSettings()`, `setNetworkSettings()`

### `src/main/n8n-manager.ts`
- Added `NetworkSettings` interface
- Added `networkSettings` member variable
- Added `setNetworkSettings()` and `getNetworkSettings()` methods
- Added `buildNetworkEnvVars()` private method to construct environment variables
- Modified `start()` to include network environment variables when spawning n8n

### `src/main/index.ts`
- Added `showNetworkSettingsDialog()` function
- Added `configureSessionProxy()` function for Electron session proxy
- Added IPC handlers:
  - `get-network-settings`
  - `save-network-settings-and-restart`
  - `close-network-settings`
  - `select-certificate-file`
- Updated menu to include "Network Settings..." option
- Modified `startN8n()` to load and apply network settings on startup
- Fixed pre-existing TypeScript errors in menu code

### `src/main/preload.ts`
- Added type definitions for `ProxyConfig`, `CACertConfig`, `NetworkSettings`
- Added IPC bridge methods:
  - `getNetworkSettings()`
  - `saveNetworkSettingsAndRestart()`
  - `closeNetworkSettings()`
  - `selectCertificateFile()`

### `src/renderer/network-settings.html` (New File)
- Network settings dialog UI with:
  - Proxy enable/disable checkbox
  - Proxy server URL input
  - Proxy bypass list input
  - CA certificate enable/disable checkbox
  - Certificate file path input with browse button
  - Save & Restart / Cancel buttons

## Environment Variables Passed to n8n

When proxy is enabled:
```
HTTP_PROXY=<proxy_server>
HTTPS_PROXY=<proxy_server>
http_proxy=<proxy_server>
https_proxy=<proxy_server>
NO_PROXY=localhost,127.0.0.1,<user_bypass_list>
no_proxy=localhost,127.0.0.1,<user_bypass_list>
```

When CA certificate is enabled:
```
NODE_EXTRA_CA_CERTS=<path_to_certificate_file>
```

## Configuration Storage

Settings are persisted in `n8tive_config.json`:

```json
{
  "port": 5678,
  "proxy": {
    "enabled": true,
    "server": "http://proxy.company.com:8080",
    "bypass": "*.local,internal.company.com"
  },
  "caCert": {
    "enabled": true,
    "path": "C:\\path\\to\\company-ca.pem"
  }
}
```

## User Interface

Access via:
- **Menu Bar**: File > Settings > Network Settings...
- **System Tray**: Right-click > Settings > Network Settings...

The dialog provides:
- Clear enable/disable toggles for both proxy and CA certificate
- Input validation for proxy URL format
- File browser for certificate selection (supports .pem, .crt, .cer)
- Warning about restart requirement
- Confirmation when closing with unsaved changes

## Dual Proxy Configuration

The implementation configures proxy at two levels:

1. **n8n Process Level**: Environment variables passed to forked n8n process
   - Affects all HTTP/HTTPS requests made by n8n workflows and integrations
   
2. **Electron Session Level**: `session.setProxy()` on BrowserWindow
   - Affects the n8n Editor UI loaded in the Electron window

## Testing Recommendations

1. **Proxy Test**:
   - Configure proxy settings pointing to corporate proxy
   - Create a workflow with HTTP Request node to external API
   - Verify traffic routes through proxy

2. **CA Certificate Test**:
   - Export enterprise CA certificate (e.g., Zscaler root CA)
   - Configure certificate path in settings
   - Verify HTTPS connections to SSL-inspected sites work without certificate errors

3. **Bypass Test**:
   - Add internal hosts to bypass list
   - Verify direct connections to those hosts

## Known Limitations

1. Some n8n nodes (AWS Bedrock, Azure OpenAI LangChain) don't fully support `NO_PROXY` environment variable
2. Git operations within n8n may not respect proxy settings in some configurations
3. Certificate file must be in PEM format

## Conclusion

Corporate network support has been successfully implemented through runtime configuration, requiring no modifications to the bundled n8n. Users can configure proxy and CA certificate settings through the UI, and these settings are applied when n8n process starts.
